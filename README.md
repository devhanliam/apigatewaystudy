# 환경
- 스프링부트 3.1.8
- JDK 17
- Postgresql latest
- Redis latest

# 로그인 요청 시
![image](https://github.com/devhanliam/apigatewaystudy/assets/117329492/becf0808-0b6d-4f81-8d5b-3a7a18627bd9)

1. API GATEWAY에 로그인 요청을 보냄
2. 사용자 조회 및 비밀번호 검증
3. 완료시 접근 토큰과 갱신 토큰을 발행하면 갱신토큰을 Redis에 저장
4. 발행된 토큰을 사용자에게 반환

# 서비스 접근 시
![image](https://github.com/devhanliam/apigatewaystudy/assets/117329492/f8774fd2-fe47-4130-a7e3-b6e2b41df908)

1. 사용자 토큰과 함께 보호된 서비스 요청
2. API GATEWAY에서 토큰 검증 및 권한체크
3. 토큰 만료시 Redis의 갱신토큰 조회 및 검증
3-1. 갱신 후 신규 접근 토큰 발행
4. 검증 완료 후 요청 리소스에 라우팅

# 성능 체크
WebFlux API GATEWAY 기능을 공부하게 된 이유는 여러 서비스 서버에 일일이 보안검증기능을 넣는것은 비효율적이라 생각했다.<br/>
하지만 하나의 서버에 모든 서비스 서버의 인증을 맡기 때문에 많은 처리를 할 수 있어야했다.<br/>
기본 WebMVC는 동기적으로 작동하기때문에 적합하지않다 생각했고 WebFlux를 선택하게 됐다.<br/>
하지만 WebFlux를 이용한다해도 동기로 작동하도록 코딩한다면 원하는 성능이 나오지않는다는걸 알게됐다.<br/>
jMeter를 이용해 부하테스트를 진행해봤다.<br/>

조건은 100개의 스레드가 5초마다 요청을 10번 반복하도록 설정했다.
1. 로그인 성능
   최초에는 H2 인메모리 DB를 사용했을땐 TPS가 11이라는 처참한 성능을 보였다.<br/>
   제대로된 테스트 결과값이 아니다 생각했고 이후 Postgresql을 이용해 진행했는데 TPS가 60대로 향상되었다.<br/>
   기본 WebMVC에서 로그인 인증 성능을 진행했는데 TPS가 50대가 나왔다.<br/>
   만족스럽지않은 결과였다. 아무래도 로그인 검증 특성상 DB를 조회하기 때문인지 제대로된 성능이 나오질 않았다.

2. JWT 인증 처리
   단순히 JWT인증 처리 후 서비스의 단순 응답을 받는 부분에서 WebMVC에 비해 큰 성능차이를 보였다.<br/>
   WebMVC의 평균 TPS는 600대 였지만 WebFlux는 1000대를 보이며 큰 차이가 나타났다.

# 고칠점
일단 성능테스를 진행했으나 로그인 처리에서 제대로된 결과가 나오질 않아 보완이 필요해보인다.<br/>
로그인 성능이 WebMVC도 제한되는걸 보면 테스트 방법이나 코드애 문제가 있는것 같다.
